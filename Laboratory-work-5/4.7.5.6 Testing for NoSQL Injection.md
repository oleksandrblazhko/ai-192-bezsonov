## Тестування для впровадження NoSQL

### Резюме
Бази даних NoSQL забезпечують менші обмеження узгодженості, ніж традиційні бази даних SQL. Вимагаючи менше реляційних обмежень і перевірок узгодженості, бази даних NoSQL часто пропонують переваги продуктивності та масштабування. Проте ці бази даних все ще потенційно вразливі до ін’єкційних атак, навіть якщо вони не використовують традиційний синтаксис SQL. Оскільки ці атаки ін’єкцій NoSQL можуть виконуватися в межах процедурної мови, а не декларативної мови SQL, потенційні наслідки є більшими, ніж традиційні ін’єкції SQL.

Виклики бази даних NoSQL записуються на мові програмування додатка, користувацькому виклику API або форматуються відповідно до загальноприйнятих умов (наприклад, `XML`, `JSON`, `LINQ` тощо). Зловмисне введення, націлене на ці специфікації, може не запускати першочергову перевірку дезінфекції програми. Наприклад, відфільтрування звичайних спеціальних символів HTML, таких як `< > & ;` не запобігатиме атакам на API JSON, де спеціальні символи включають `/ { } :`.

Зараз існує понад 150 баз даних NoSQL, доступних для використання в програмі, що надає API різними мовами та моделями зв’язків. Кожен пропонує різні функції та обмеження. Оскільки між ними немає спільної мови, приклад коду ін’єкції не застосовуватиметься до всіх баз даних NoSQL. З цієї причини кожен, хто тестує атаки ін’єкцій NoSQL, повинен буде ознайомитися з синтаксисом, моделлю даних і базовою мовою програмування, щоб створювати конкретні тести.

Атаки ін’єкцій NoSQL можуть виконуватися в інших областях програми, ніж традиційні ін’єкції SQL. Якщо SQL-ін’єкція виконується в системі бази даних, варіанти NoSQL можуть виконуватися на прикладному рівні або на рівні бази даних, залежно від використовуваного API NoSQL і моделі даних. Зазвичай атаки ін’єкції NoSQL виконуються, коли рядок атаки аналізується, оцінюється або об’єднується у виклик NoSQL API.

Додаткові атаки на синхронізацію можуть мати відношення до відсутності перевірок паралельності в базі даних NoSQL. Вони не підпадають під ін'єкційне тестування. На момент написання MongoDB є найбільш широко використовуваною базою даних NoSQL, тому всі приклади містять API MongoDB.

### Як тестувати
#### Тестування вразливостей NoSQL Injection у MongoDB
API MongoDB очікує викликів BSON (Binary JSON) і включає безпечний інструмент складання запитів BSON. Однак, згідно з документацією MongoDB, несеріалізовані вирази JSON і JavaScript дозволені в кількох альтернативних параметрах запиту. Найпоширенішим викликом API, що дозволяє довільний вхід JavaScript, є оператор `$where`.
Оператор MongoDB `$where` зазвичай використовується як простий фільтр або перевірка, як і в SQL.
`db.myCollection.find( { $where: "this.credits == this.debits" } );`
За бажанням JavaScript також оцінюється для більш складних умов.
`db.myCollection.find( { $where: function() { return obj.credits - obj.дебети < 0; } } );`

#### Приклад 1
Якщо зловмиснику вдалося маніпулювати даними, переданими в оператор `$where`, він міг би включити довільний JavaScript для оцінки як частину запиту MongoDB. У наведеному нижче коді виявляється приклад уразливості, якщо дані користувача передаються безпосередньо в запит MongoDB без очищення.
`db.myCollection.find( { active: true, $where: function() { return obj.credits - obj.debits < $userInput; } } );;`
Як і під час тестування інших типів ін’єкцій, не потрібно повністю використовувати вразливість, щоб продемонструвати проблему. Вставляючи спеціальні символи, відповідні цільовій мові API, і спостерігаючи за результатами, тестувальник може визначити, чи правильно програма очистила вхідні дані. Наприклад, у MongoDB, якщо рядок, що містить будь-який із наведених нижче спеціальних символів, було передано необробленим, це спричинило б помилку бази даних.
`' " \ ; { }`

При звичайному SQL-ін’єкції подібна вразливість дозволить зловмиснику виконувати довільні команди SQL, відкриваючи або маніпулюючи даними за бажанням. Однак, оскільки JavaScript є повнофункціональною мовою, це дозволяє зловмисникам не тільки маніпулювати даними, але й запускати довільний код. Наприклад, замість того, щоб просто викликати помилку під час тестування, повний експлойт використовуватиме спеціальні символи для створення дійсного JavaScript.

Цей вхід `0;var date=new Date(); do{curDate = new Date();}while(curDate-date<10000)`, вставлений у `$userInput` у наведеному вище прикладі коду, призведе до виконання такої функції JavaScript. Цей конкретний рядок атаки призведе до виконання всього екземпляра MongoDB із 100% використанням ЦП протягом 10 секунд.

`function() { return obj.credits - obj.debits < 0;var date=new Date(); do{curDate = new Date();}while(curDate-date<10000); }`

#### Приклад 2
Навіть якщо вхідні дані, що використовуються в запитах, повністю оброблені або параметризовані, існує альтернативний шлях, за яким можна запустити ін’єкцію NoSQL. Багато екземплярів NoSQL мають власні зарезервовані імена змінних, незалежно від мови програмування програми.

Наприклад, у MongoDB сам синтаксис `$where` є зарезервованим оператором запиту. Його потрібно передати в запит точно так, як показано; будь-яка зміна призведе до помилки бази даних. Однак, оскільки `$where` також є дійсним ім’ям змінної PHP, зловмисник може вставити код у запит, створивши змінну PHP з іменем `$where`.Документація PHP MongoDB чітко застерігає розробників:

Переконайтеся, що для всіх спеціальних операторів запиту (починаючи з `$`) ви використовуєте одинарні лапки, щоб PHP не намагався замінити `$exists` значенням змінної `$exists`.

Навіть якщо запит не залежав від введення користувача, як у наступному прикладі, зловмисник може використати MongoDB, замінивши оператор шкідливими даними.
`db.myCollection.find( { $where: function() { return obj.credits - obj.debits < 0; } } );`

Один із способів потенційно призначити дані змінним PHP — це забруднення параметрів HTTP (див.: Тестування на забруднення параметрів HTTP). Створивши змінну з іменем `$where` через забруднення параметра, можна викликати помилку MongoDB, яка вказує на те, що запит більше недійсний. Будь-яке значення `$where`, окрім самого рядка `$where`, має бути достатнім для демонстрації вразливості. Зловмисник розробить повний експлойт, вставивши наступне:

`$where: function() { //довільний JavaScript тут }`
