## Тестування ін'єкції ORM

### Резюме
Ін’єкція об’єктно-реляційного відображення (ORM) — це атака з використанням ін’єкції SQL проти згенерованої ORM об’єктної моделі доступу до даних. З точки зору тестувальника, ця атака практично ідентична атаці SQL Injection. Однак у коді, згенерованому рівнем ORM, існує вразливість ін’єкції.

Переваги використання інструменту ORM включають швидке створення об’єктного рівня для зв’язку з реляційною базою даних, стандартизацію шаблонів коду для цих об’єктів і те, що вони зазвичай забезпечують набір безпечних функцій для захисту від атак SQL Injection. Згенеровані ORM об’єкти можуть використовувати SQL або, у деяких випадках, варіант SQL для виконання операцій CRUD (Створення, Читання, Оновлення, Видалення) у базі даних. Однак веб-додаток, який використовує згенеровані ORM об’єкти, може бути вразливим до атак SQL-ін’єкцій, якщо методи можуть приймати несанкціоновані вхідні параметри.

### Як тестувати
Рівні ORM можуть бути схильні до вразливості, оскільки вони розширюють поверхню атаки. Замість того, щоб безпосередньо націлювати програму за допомогою запитів SQL, ви зосередитеся на зловживанні рівнем ORM для надсилання зловмисних запитів SQL.

#### Визначте рівень ORM
Для ефективного тестування та розуміння того, що відбувається між вашими запитами та серверними запитами, а також для всього, що пов’язано з проведенням належного тестування, важливо визначити технологію, яка використовується. Дотримуючись розділу збору інформації, ви маєте знати про технологію, яку використовує дана програма. Перевірте цей список зіставлення мов із відповідними ORM.

#### Зловживання рівнем ORM
Після визначення можливого ORM, який використовується, стає важливим зрозуміти, як функціонує його синтаксичний аналізатор, і вивчити методи його зловживання, або навіть, можливо, якщо програма використовує стару версію, визначити CVE, що стосуються використовуваної бібліотеки. Іноді рівні ORM не реалізовані належним чином, і тому тестувальник може виконувати звичайне впровадження SQL, не турбуючись про рівень ORM.
#### Слабка реалізація ORM
Вразливий сценарій, коли рівень ORM не було реалізовано належним чином, взято з SANS:
```
List results = session.createQuery("from Orders as orders where orders.id = " + currentOrder.getId()).list();
List results = session.createSQLQuery("Select * from Books where author = " + book.getAuthor()).list();
```
Вище не було реалізовано позиційний параметр, який дозволяє розробнику замінити введення на `?`. Прикладом може бути такий:
```
Query hqlQuery = session.createQuery("from Orders as orders where orders.id = ?");
List results = hqlQuery.setString(0, "123-ADB-567-QTWYTFDL").list(); // 0 is the first position, where it is dynamically replaced by the string set
```
Ця реалізація залишає перевірку та очищення на рівні ORM, і єдиним способом обійти це буде виявлення проблеми на рівні ORM.

#### Вразливий рівень ORM
Рівні ORM – це код, більшість часу сторонні бібліотеки. Вони можуть бути вразливими, як і будь-який інший фрагмент коду. Одним із прикладів може бути бібліотека sequelize ORM npm, яка була визнана вразливою в 2019 році. В іншому дослідженні, проведеному RIPS Tech, були виявлені обхідні шляхи в ORM у режимі сну, який використовується Java.

Базуючись на їхній статті в блозі, шпаргалка, яка може дозволити тестувальнику виявити проблеми, може бути окреслена так:
|DBMS|SQL Injection|
|:--------:|:--------:|
|MySQL|`abc\' INTO OUTFILE --`|
|PostgreSQL|`$$='$$=chr(61)||chr(0x27) and 1=pg_sleep(2)||version()'`|
|Oracle|NVL(TO_CHAR(DBMS_XMLGEN.getxml('select 1 where 1337>1')),'1')!='1'|
|MS SQL|1<LEN(%C2%A0(select%C2%A0top%C2%A01%C2%A0name%C2%A0from%C2%A0users)|

Іншим прикладом може бути Laravel Query-Builder, який виявився вразливим у 2019 році.
